# 🔧 v2.2.1 修复说明

## 问题描述

用户反馈v2.2.0版本存在以下问题：
1. 智能划词功能仍需要手动按Ctrl+C才能触发
2. Dify API调用时所有按钮都返回"处理完成"，没有实际内容

## 修复内容

### 1. 智能划词检测优化
- **问题原因**：原实现等待用户手动触发复制操作
- **解决方案**：
  - 改为主动定时检测（每500ms）
  - 自动清空剪贴板并模拟复制操作
  - 智能判断是否有新文本被选中
  - 添加防抖机制避免重复触发

### 2. Dify API 流式响应修复
根据用户反馈的关键改动：
- **自动协议选择**：根据URL自动选择http/https客户端
- **错误处理优化**：
  - 非2xx状态码立即读取错误体并快速失败
  - 便于定位鉴权/网关错误
- **数据解析改进**：
  - 使用缓冲区逐行解析SSE事件
  - 兼容只含answer或含[DONE]的情况
  - 正确处理message和message_end事件
- **查询文本处理**：使用prompt（如果有）而不是原始text

## 技术细节

### 智能划词实现
```javascript
// 每500ms检测一次
setInterval(() => {
    // 1. 保存当前剪贴板
    const oldClipboard = clipboard.readText();
    
    // 2. 清空剪贴板
    clipboard.clear();
    
    // 3. 模拟复制操作
    robot.keyTap('c', 'control');
    
    // 4. 检查是否有新文本
    const selectedText = clipboard.readText();
    
    // 5. 恢复原剪贴板
    clipboard.writeText(oldClipboard);
    
    // 6. 如果有新文本，显示AI按钮
    if (selectedText && selectedText !== lastSelectedText) {
        showFloatingWindow(mousePos, selectedText);
    }
}, 500);
```

### Dify API 修复
```javascript
// 自动选择协议
const protocol = parsedUrl.protocol === 'https:' ? https : http;

// 错误快速失败
if (res.statusCode < 200 || res.statusCode >= 300) {
    let errorBody = '';
    res.on('data', chunk => errorBody += chunk);
    res.on('end', () => {
        reject(new Error(`API请求失败 (${res.statusCode}): ${errorBody}`));
    });
    return;
}

// 使用prompt而不是text
const queryText = data.prompt || data.text;
```

## 测试建议

1. **智能划词测试**：
   - 在不同应用中选中文本
   - 无需按任何键，AI按钮应自动出现
   - 验证剪贴板内容未被改变

2. **Dify API测试**：
   - 配置正确的API Key
   - 测试各个功能按钮（翻译、解释、总结等）
   - 验证流式响应实时显示

## 版本信息

- 版本号：v2.2.1
- 发布日期：2024-08-08
- 修复内容：智能划词检测、Dify API流式响应